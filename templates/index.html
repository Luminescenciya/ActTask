<!DOCTYPE html>
<html lang="en">
   <meta charset="utf-8" />
   <head>
      <title>Управление акциями</title>
      <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
      <script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jquery.templates/beta1/jquery.tmpl.js"></script>
      <link href="https://getbootstrap.com/docs/3.4/dist/css/bootstrap.min.css" rel="stylesheet">
      <link href="../static/jumbotron-narrow.css" rel="stylesheet">
      <link href="../static/style.css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/tablesort/5.1.0/tablesort.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/tablesort/5.1.0/sorts/tablesort.number.min.js"></script>
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.js"></script>
      <script src="http://code.jquery.com/ui/1.11.1/jquery-ui.min.js"></script>
      <script>
         $(function() {
             new Tablesort(document.getElementById('tableact'), {
                 descending: false
             });
             GetActs();
         });
         
         function GetActs() {
             $.ajax({
                 url: '/GetActs',
                 type: 'GET',
                 success: function(res) {
         
                     var wishObj = JSON.parse(res);
                     console.log(wishObj);
                     $('#ulist').empty();
                     $('#listTemplate').tmpl(wishObj).appendTo('#ulist');
         
                 },
                 error: function(error) {
                     console.log(error);
                 }
             });
         }
         
         function SaveNums() {
             var array = [];
             $(function () {
                 $('#ulist tr').each(function (a, b) {
                     var id = $('.Id', b).text();
                     var num = $('.index', b).text();
                     array.push({ Id: id, Num: num });
                 });
             
             
             console.log( array);
             $.ajax({
                 url: '/SaveNums',
                 data: {array:JSON.stringify(array)},
                 type: 'POST',
                 success: function(res) {
                     document.location.reload(true)  
                 },
                 
                 error: function(error) {
                     console.log(error);
                 }
             });
         });
         }
             
         function ConfirmDelete(elem) {
             localStorage.setItem('deleteId', $(elem).attr('data-id'));
             $('#deleteModal').modal();
         }
         
         function Delete() {
             $.ajax({
                 url: '/deleteAct',
                 data: {
                     IdDel: localStorage.getItem('deleteId')
                 },
                 type: 'POST',
                 success: function(res) {
                     var result = JSON.parse(res);
                     $('#deleteModal').modal('hide');
                     GetActs();
                 },
                 error: function(error) {
                     console.log(error);
                     GetActs();
                 }
             });
         }
         
         function Edit(elm) {
             $.ajax({
                 url: '/getActByNumber',
                 data: {
                     Num: $(elm).attr('data-id')
                 },
                 type: 'POST',
                 success: function(res) {
                     var data = JSON.parse(res);
                     if (data ==='error'){
                         alert('Ошибка! \nАкции нет в базе данных. Обновите страницу для продолжения.');
                     }
                     else{
                         document.getElementById("editActive").checked = false;
         
                         $('#editTitle').val(data['Title']);
                         $('#editDescription').val(data['Description']);
                         $('#editNumber').val(data['Id']);
                         $('#editName').val(data['Name']);
                         if (data['Active'] === true) {
         
                             document.getElementById("editActive").checked = true;
                         }
                         $('#editModal').modal();
                         document.getElementById("imageBox2").src="data:image;base64," +data['Picture'];
                         document.getElementById("refForimageBox2").href="/picture/"+data['Id']+".jpg";
                     }
                 },
                     
                 error: function(error) {
                     console.log(error);
                 }
             });
         }
      </script>
   </head>
   <body>
      <div class="container">
         <div class="header">
            <nav>
               <ul class="nav nav-pills pull-right">
                    <button title="Номера акций были изменены. Нажмите, чтобы сохранить." type="button" class="btn btn-success btn-lg" id="SaveNumButton" onclick="SaveNums()" style="display:none;">Сохранить
                    </button>
                    <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#NewModal">Добавить акцию
                    </button>
               </ul>
            </nav>
            <h3 class="text-muted">Управление акциями</h3>
         </div>
         <div class="form-group">
            <input type="text" id="myinput" onkeyup="myFunction()" class="search form-control" placeholder="Поиск в названиях, заголовках и описаниях...">
         </div>
         <script>
            function myFunction() {
                var input, filter, table, tr, td, cell, i, j;
                input = document.getElementById("myinput");
                filter = input.value.toUpperCase();
                table = document.getElementById("tableact");
                tr = table.getElementsByTagName("tr");
                for (i = 1; i < tr.length; i++) {
                    tr[i].style.display = "none";
                    td = tr[i].getElementsByTagName("td");
                    for (var j = 0; j < 4; j++) {
                    cell = tr[i].getElementsByTagName("td")[j];
                    console.log(cell)
                    if (cell) {
                        if (cell.innerHTML.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                        break;
                        } 
                    }
                    }
                }
            };
         </script>
         <span class="counter pull-right"></span>
         <script id="listTemplate" type="text/x-jQuery-tmpl">
            <tr>
                <td style="display:none;" class="Id">
                    ${Id} 
                </td>
                <td class="Name">
                    ${Name} 
                </td>
                <td>
                    <a target="_blank" href="/picture/${Id}.jpg">
                    <img src="data:image;base64,${Image}" id="imageBox"/>
                    </a>
                </td>
                <td>
                    ${Title}
                </td>
                <td>
                    ${Description}
                </td>
                <td>
                    ${Active}

                </td>
                <td class="index">
                    ${Num}
                </td>
                <td>
                    ${Date}
                </td>
                <td>
                    <p><a data-id=${Id} title="Изменение акции" onclick="Edit(this)"><span class="glyphicon glyphicon-pencil"></span></a></p>
                    <p><a data-id=${Id}  title="Удаление акции" onclick="ConfirmDelete(this)"><span class="glyphicon glyphicon-trash"></span></a></p>
                </td>
            </tr>
            
         </script>
         <table id="tableact" class="table table-striped table-bordered table-hover">
            <thead>
               <tr>
                  <th class="text" id="head" >Название акции</th>
                  <th class="text" data-sort-method='none'>Изображение</th>
                  <th class="text" id="head" >Заголовок</th>
                  <th class="text" data-sort-method='none'>Описание</th>
                  <th class="text" id="head" >Активность</th>
                  <th class="text" id="head" data-sort-method='number'>Номер акции</th>
                  <th class="text" id="head" >Дата создания</th>
                  <th class="text" data-sort-method='none'>Действия</th>
               </tr>
            </thead>
            <tbody id="ulist">
            </tbody>
         </table>
         <script>
            var fixHelperModified = function(e, tr) {
            var $originals = tr.children();
            var $helper = tr.clone();
            $helper.children().each(function(index) {
                $(this).width($originals.eq(index).width())
            });
            return $helper;
            },
            updateIndex = function(e, ui) {
                var start_pos = ui.item.data('start_pos');
                if (start_pos != ui.item.index()) {
                $('td.index', ui.item.parent()).each(function (i) {
                    $(this).html(i + 1); 
                });
            };
            }
            $("#ulist").sortable({
                start: function(event, ui) {
            ui.item.data('start_pos', ui.item.index());
            },
                helper: fixHelperModified,
                stop: updateIndex,
                update: function(event, ui) {
                    document.getElementById("SaveNumButton").style.display="inline-block"
            }
            }).disableSelection();
         </script>
         <footer class="footer">
         </footer>
      </div>
      </div>
      <div class="modal fade" data-backdrop="false" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel">
         <div class="modal-dialog">
            <div class="modal-content">
               <div class="modal-header" style="text-align:center;">
                  <h4 class="modal-title" style="color:red;" id="deleteModalLabel">Удалить акцию?</h4>
               </div>
               <div class="modal-footer">
                  <button type="button" class="btn btn-default" data-dismiss="modal">Назад</button>
                  <button type="button" class="btn btn-primary" onclick="Delete()">Удалить</button>
               </div>
            </div>
         </div>
      </div>
      <div class="modal fade" data-backdrop="false" id="NewModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel">
         <div class="modal-dialog">
            <div class="modal-content">
               <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
                  </button>
                  <h4 class="modal-title" id="editModalLabel">Создание акции</h4>
               </div>
               <div class="modal-body">
                  <form action="/createAct" method="POST" enctype="multipart/form-data">
                     <div class="form-group">
                        <label for="recipient-name" class="control-label">Название:</label>
                        <input type="text" class="form-control" name="inputName" required autofocus>
                     </div>
                     <div class="form-group">
                        <label for="message-text" class="control-label">Заголовок:</label>
                        <input class="form-control" name="inputTitle" required autofocus>
                     </div>
                     <div class="form-group">
                        <label for="message-text" class="control-label">Описание:</label>
                        <input class="form-control" name="inputDescription" required autofocus>
                     </div>
                     <div class="form-group">
                        <label for="message-text" class="control-label">Активность:</label>
                        <input type="checkbox" name="inputActive">
                     </div>
                     <div class="form-group">
                        <label for="message-text" class="control-label">Изображение:</label>
                        <p>
                        </p>
                        <input type="file" accept="image/x-png" name="inputPicData" required autofocus>
                     </div>
               </div>
               <div class="modal-footer">
               <button type="button" class="btn btn-default" data-dismiss="modal">Закрыть</button>
               <button type="submit" id="btnUpdate" class="btn btn-primary">Создать</button>
               </div>
               </form>
            </div>
         </div>
      </div>
      <div class="modal fade" data-backdrop="false" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel">
         <div class="modal-dialog">
            <div class="modal-content">
               <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
                  </button>
                  <h4 class="modal-title" id="editModalLabel">Изменение акции</h4>
               </div>
               <div class="modal-body">
                  <form action="/editAct" method="POST" enctype="multipart/form-data">
                     <div class="form-group">
                        <label for="recipient-name" class="control-label">Название:</label>
                        <input type="text" class="form-control" id="editName" name="editName" required autofocus>
                     </div>
                     <div class="form-group">
                        <label for="message-text" class="control-label">Заголовок:</label>
                        <input class="form-control" id="editTitle" name="editTitle" required autofocus>
                     </div>
                     <div class="form-group">
                        <label for="message-text" class="control-label">Описание:</label>
                        <input class="form-control" id="editDescription" name="editDescription" required autofocus>
                     </div>
                     <div class="form-group">
                        <label for="message-text" class="control-label">Активность:</label>
                        <input type="checkbox" id="editActive" name="editActive" value="1">
                     </div>
                     <div class="form-group">
                        <label for="message-text" class="control-label">Изображение:</label>
                        <p>
                        </p>
                        <a target="_blank" id="refForimageBox2">
                        <img name="imageBox2" id="imageBox2"/>
                        </a>
                        <p>
                        </p>
                        <input type="file" accept="image/x-png" id="editPicData" name="editPicData">
                     </div>
                     <input type="hidden" id="editNumber" name="editNumber">
               </div>
               <div class="modal-footer">
               <button type="button" class="btn btn-default" data-dismiss="modal">Закрыть</button>
               <button type="submit" id="btnUpdate" class="btn btn-primary">Изменить</button>
               </div>
               </form>
            </div>
         </div>
      </div>
   </body>
</html>